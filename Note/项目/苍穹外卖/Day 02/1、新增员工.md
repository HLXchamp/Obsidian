### 需求分析与设计

![[Pasted image 20240514122505.png]]

![[Pasted image 20240514122552.png]]

![[Pasted image 20240514122722.png]]

### 代码开发

![[Pasted image 20240514122839.png]]

EmployeeController：

```java
@PostMapping  
@ApiOperation("新增员工")  
public Result save(@RequestBody EmployeeDTO employeeDTO) {  
    log.info("新增员工：{}", employeeDTO);  
    employeeService.save(employeeDTO);  
    return Result.success();  
}
```

EmployeeService：

```java
/**  
 * 新增员工  
 * @param employeeDTO  
 * @return  
 */  
void save(EmployeeDTO employeeDTO);
```

EmployeeServiceImpl：

```java
/**  
 * 新增员工  
 * @param employeeDTO  
 */  
@Override  
public void save(EmployeeDTO employeeDTO) {  
    Employee employee = new Employee();  
  
    //对象拷贝属性  
    BeanUtils.copyProperties(employeeDTO, employee); // 前面是源，后面是目标，将employeeDTO转化成employee对象传给数据库  
  
    //设置密码，默认123456，直接使用常量类提供的值就好，更规范  
    employee.setPassword(DigestUtils.md5DigestAsHex(PasswordConstant.DEFAULT_PASSWORD.getBytes()));  
  
    //设置创建和修改时间  
    employee.setCreateTime(LocalDateTime.now());  
    employee.setUpdateTime(LocalDateTime.now());  
  
    //设置当前创建人和修改人  
    //TODO  
    employee.setCreateUser(10L);  
    employee.setUpdateUser(10L);  
  
    employeeMapper.insert(employee);  
}
```

EmployeeMapper（status默认是1，就没有添加）：

```java
/**  
 * 新增员工  
 * @param employee  
 */  
@Insert("insert into employee (name, username, password, phone, sex, id_number, create_time, update_time, create_user, update_user)" +  
"values" + "(#{name},#{username},#{password},#{phone},#{sex},#{idNumber},#{createTime},#{updateTime},#{createUser},#{updateUser})")  
void insert(Employee employee);
```

### 功能测试

可以用Swagger和前后端联调测试。用Swagger时要获取一下jwt令牌的token并作为请求头传给服务端。

![[Pasted image 20240515102119.png]]

![[Pasted image 20240514133318.png]]

### 代码完善

![[Pasted image 20240514214218.png|425]]

#### 解决用户名存在的异常

在GlobalExceptionHandler中加入异常检测：

```java
/**  
 * 处理SQL异常  
 * @param ex  
 * @return  
 */  
@ExceptionHandler  
public Result exceptionHandler(SQLIntegrityConstraintViolationException ex){  
    //Duplicate entry 'zhangsan' for key 'idx_username'  
    String message = ex.getMessage();  
    if(message.contains("Duplicate entry")){  
        String[] split = message.split(" ");  
        String username = split[2];  
        String msg = username + MessageConstant.ALREADY_EXISTS;  
        return Result.error(msg);  
    }else{  
        return Result.error(MessageConstant.UNKNOWN_ERROR);  
    }  
}
```

用户名存在时会报错并返回给前端：

![[Pasted image 20240514234257.png]]

![[Pasted image 20240514234659.png|500]]

#### 解决新增员工对应ID是固定的

![[Pasted image 20240515091704.png|500]]

![[Pasted image 20240515091756.png]]

ThreadLocal：

![[Pasted image 20240515092539.png]]

BaseContest：

```java
public class BaseContext {  
  
    public static ThreadLocal<Long> threadLocal = new ThreadLocal<>();  
  
    public static void setCurrentId(Long id) {  
        threadLocal.set(id);  
    }  
  
    public static Long getCurrentId() {  
        return threadLocal.get();  
    }  
  
    public static void removeCurrentId() {  
        threadLocal.remove();  
    }  
  
}
```

JwtTokenAdminInterceptor里传递当前ID：

```java
public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {  
    //判断当前拦截到的是Controller的方法还是其他资源  
    if (!(handler instanceof HandlerMethod)) {  
        //当前拦截到的不是动态方法，直接放行  
        return true;  
    }  
  
    //1、从请求头中获取令牌  
    String token = request.getHeader(jwtProperties.getAdminTokenName());  
  
    //2、校验令牌  
    try {  
        log.info("jwt校验:{}", token);  
        Claims claims = JwtUtil.parseJWT(jwtProperties.getAdminSecretKey(), token);  
        Long empId = Long.valueOf(claims.get(JwtClaimsConstant.EMP_ID).toString());  
        log.info("当前员工id：", empId); 
        //传当前ID
        BaseContext.setCurrentId(empId);  
        
        //3、通过，放行  
        return true;  
    } catch (Exception ex) {  
        //4、不通过，响应401状态码  
        response.setStatus(401);  
        return false;  
    }  
}
```

在service中：

```Java
//设置当前创建人和修改人  
employee.setCreateUser(BaseContext.getCurrentId());  
employee.setUpdateUser(BaseContext.getCurrentId());
```

添加成功：
![[Pasted image 20240515093000.png]]
