### 需求分析与设计

![[Pasted image 20240522100539.png]]

![[Pasted image 20240522100601.png|325]]

![[Pasted image 20240522100622.png]]

![[Pasted image 20240522100917.png]]

### 代码开发

逻辑比较复杂：

新建一个ShoppingCartController：

```java
@RestController  
@RequestMapping("/user/shoppingCart")  
@Slf4j  
@Api(tags = "C端购物车相关接口")  
public class ShoppingCartController {  
  
    @Autowired  
    private ShoppingCartService shoppingCartService;  
  
    @PostMapping("/add")  
    @ApiOperation("添加购物车")  
    public Result add(@RequestBody ShoppingCartDTO shoppingCartDTO){  
        log.info("添加购物车，商品信息为：{}",shoppingCartDTO);  
        shoppingCartService.addShoppingCart(shoppingCartDTO);  
        return Result.success();  
    }  
}
```

新建一个ShoppingCartService和ShoppingCartServiceImpl：

```java
public interface ShoppingCartService {  
    /**  
     * 添加购物车  
     * @param shoppingCartDTO  
     */  
    void addShoppingCart(ShoppingCartDTO shoppingCartDTO);  
}
```

首先获取userId，然后判断当前加入到购物车中的商品是否已经存在了，存在的话只需要将number加一，否则就插入数据，插入时要判断是菜品还是套餐 ：

```java
@Service  
@Slf4j  
public class ShoppingCartServiceImpl implements ShoppingCartService {  
  
    @Autowired  
    private ShoppingCartMapper shoppingCartMapper;  
    @Autowired  
    private DishMapper dishMapper;  
    @Autowired  
    private SetmealMapper setmealMapper;  
  
    /**  
     * 添加购物车  
     * @param shoppingCartDTO  
     */  
    @Override  
    public void addShoppingCart(ShoppingCartDTO shoppingCartDTO) {  
        //判断当前加入到购物车中的商品是否已经存在了  
        ShoppingCart shoppingCart = new ShoppingCart();  
        BeanUtils.copyProperties(shoppingCartDTO, shoppingCart);  
        //获取userId  
        Long userId = BaseContext.getCurrentId();  
        shoppingCart.setUserId(userId);  
  
        List<ShoppingCart> list = shoppingCartMapper.list(shoppingCart);  
  
        //如果已经存在了，只需要将数量+1  
        if (list != null && !list.isEmpty()) {  
            ShoppingCart cart = list.get(0);  
            cart.setNumber(cart.getNumber() + 1);  
            shoppingCartMapper.updateNumberById(cart);  
        }  
        else {  
            //如果不存在，需要插入一条购物车数据  
            //判断本次添加到购物车的是菜品还是套餐  
            Long dishId = shoppingCartDTO.getDishId();  
            if (dishId != null) {  
                Dish dish = dishMapper.getById(dishId);  
                shoppingCart.setName(dish.getName());  
                shoppingCart.setImage(dish.getImage());  
                shoppingCart.setAmount(dish.getPrice());  
            }  
            else{  
                Long setmealId = shoppingCartDTO.getSetmealId();  
                Setmeal setmeal = setmealMapper.getById(setmealId);  
                shoppingCart.setName(setmeal.getName());  
                shoppingCart.setImage(setmeal.getImage());  
                shoppingCart.setAmount(setmeal.getPrice());  
            }  
            shoppingCart.setNumber(1);  
            shoppingCart.setCreateTime(LocalDateTime.now());  
            shoppingCartMapper.insert(shoppingCart);  
        }  
    }  
}
```

ShoppingCartMapper：

```java
@Mapper  
public interface ShoppingCartMapper {  
  
    /**  
     * 动态条件查询  
     * @param shoppingCart  
     * @return  
     */  
    List<ShoppingCart> list(ShoppingCart shoppingCart);  
  
    /**  
     * 根据ID修改商品数量  
     * @param shoppingCart  
     */  
    @Update("update shopping_cart set number = #{number} where id = #{id}")  
    void updateNumberById(ShoppingCart shoppingCart);  
  
    /**  
     * 插入购物车数据  
     * @param shoppingCart  
     */  
    @Insert("insert into shopping_cart (name, image, user_id, dish_id, setmeal_id, dish_flavor, number, amount, create_time)" +  
     "values (#{name}, #{image}, #{userId}, #{dishId}, #{setmealId}, #{dishFlavor}, #{number}, #{amount}, #{createTime})")  
    void insert(ShoppingCart shoppingCart);  
}
```

```xml
<mapper namespace="com.sky.mapper.ShoppingCartMapper">  
    <select id="list" resultType="com.sky.entity.ShoppingCart">  
        select * from shopping_cart  
        <where>  
            <if test="userId != null ">  
                and user_id = #{userId}  
            </if>  
            <if test="setmealId != null ">  
                and setmeal_id = #{setmealId}  
            </if>  
            <if test="dishId != null ">  
                and dish_id = #{dishId}  
            </if>  
            <if test="dishFlavor != null ">  
                and dish_flavor = #{dishFlavor}  
            </if>  
        </where>  
    </select>  
</mapper>
```

### 测试

各种测试都没问题：

![[Pasted image 20240522111007.png]]