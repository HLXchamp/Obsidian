### 问题说明

![[Pasted image 20240521201833.png]]

### 实现思路

![[Pasted image 20240521202218.png]]

![[Pasted image 20240521202242.png]]

### 代码实现

#### 缓存菜品数据

在User中的DishController中添加缓存相关代码，如果redis中有菜品数据就直接读出来，没有的话查询数据库并加入到redis中进行缓存：

```java
    /**  
     * 根据分类id查询菜品  
     *  
     * @param categoryId  
     * @return  
     */  
    @GetMapping("/list")  
    @ApiOperation("根据分类id查询菜品")  
    public Result<List<DishVO>> list(Long categoryId) {  
        //构造redis中的key，规则：dish_分类id  
        String key = "dish_" + categoryId;  
  
        //查询redis中是否有菜品数据  
        List<DishVO> list = (List<DishVO>) redisTemplate.opsForValue().get(key); //放进去是什么类型，取出来就是什么类型  
        if (list != null && !list.isEmpty()) {  
            //如果存在就直接返回，无需查询数据库  
            return Result.success(list);  
        }  
  
        Dish dish = new Dish();  
        dish.setCategoryId(categoryId);  
        dish.setStatus(StatusConstant.ENABLE);//查询起售中的菜品  
  
        //如果不存在，查询数据库，将查询到的数据放入redis中  
        list = dishService.listWithFlavor(dish);  
        redisTemplate.opsForValue().set(key, list);  
  
        return Result.success(list);  
    }  
}
```

测试没问题：

![[Pasted image 20240521210048.png]]

### 改进代码

如果菜品信息改变了，要更新Redis中的缓存数据（可能会清除再加入）！注意：一定是在admin管理端的DishController中改变，因为用户端不能改变菜品信息！

![[Pasted image 20240521210722.png|575]]

可以用AOP，但此处改变的代码量不大，可以直接封装成一个cleanCache方法替代：

```java
/**  
 * 菜品管理  
 */  
@RestController  
@Slf4j  
@RequestMapping("/admin/dish")  
@Api(tags = "菜品管理接口")  
public class DishController {  
  
    @Autowired  
    private DishService dishService;  
  
    @Autowired  
    private RedisTemplate redisTemplate;  
  
    @PostMapping  
    @ApiOperation("新增菜品")  
    public Result save(@RequestBody DishDTO dishDTO) {  
        log.info("新增菜品：{}",dishDTO);  
        dishService.saveWithFlavor(dishDTO);  
  
        //精确清理缓存  
        String key = "dish_" + dishDTO.getCategoryId();  
        cleanCache(key);  
        return Result.success();  
    }  
  
    @GetMapping("/page")  
    @ApiOperation("菜品分页查询")  
    public Result<PageResult> page(DishPageQueryDTO dishPageQueryDTO){ //这里前端传的不是json，就不用@@RequestBody  
        log.info("菜品分页查询：{}",dishPageQueryDTO);  
        PageResult pageResult =  dishService.pageQuary(dishPageQueryDTO);  
        return Result.success(pageResult);  
    }  
  
    @DeleteMapping  
    @ApiOperation("菜品批量删除")  
    public Result delete(@RequestParam List<Long> ids) { //@RequestParam将ids根据逗号划分，再存到List集合里  
        log.info("菜品批量删除：{}",ids);  
        dishService.deleteBatch(ids);  
  
        //将所有菜品的缓存数据清理掉，所以以dish_开头的key  
        cleanCache("dish_*");  
        return Result.success();  
    }  
  
    @GetMapping("/{id}")  
    @ApiOperation("根据ID查询菜品")  
    public Result<DishVO> getById(@PathVariable Long id) {  
        log.info("根据ID查询菜品：{}",id);  
        DishVO dishVO = dishService.getByIdWithFlavor(id);  
        return Result.success(dishVO);  
    }  
  
    @PutMapping  
    @ApiOperation("修改菜品")  
    public Result update(@RequestBody DishDTO dishDTO) {  
        log.info("修改菜品：{}",dishDTO);  
        dishService.updateWithFlavor(dishDTO);  
  
        //将所有菜品的缓存数据清理掉，所以以dish_开头的key  
        cleanCache("dish_*");  
        return Result.success();  
    }  
  
    @GetMapping("/list")  
    @ApiOperation("根据分类ID查询菜品")  
    public Result<List<Dish>> getDishes(Long categoryId) {  
        log.info("根据分类ID查询菜品：{}",categoryId);  
        List<Dish> list = dishService.getDishes(categoryId);  
        return Result.success(list);  
    }  
  
    @PostMapping("/status/{status}")  
    @ApiOperation("起售停售菜品")  
    public Result updateStatus(@PathVariable Integer status, Long id) {  
        dishService.startOrStop(status, id);  
  
        //将所有菜品的缓存数据清理掉，所以以dish_开头的key  
        cleanCache("dish_*");  
        return Result.success();  
    }  
  
    /**  
     * 统一清理缓存数据  
     * @param pattern  
     */  
    private void cleanCache(String pattern){  
        Set keys = redisTemplate.keys(pattern);  
        redisTemplate.delete(keys);  
    }  
}
```

#### 测试

管理端在套餐中加了一个鸡蛋汤，可以查到：

![[Pasted image 20240521213256.png|281]]